{% extends 'Thangka_gallary/base.html' %}
{% load static %}
{% block title %}Gallery - Thangka{% endblock %}

{% block content %}
<section class="gallery-section bhutanese-page">
  <div class="page-header">
    <div class="header-accent left">༺</div>
    <h2 class="section-title">Explore Gallery</h2>
    <div class="header-accent right">༻</div>
  </div>

  <div id="pinterest-feed" class="gallery-grid">
    {% for art in artworks %}
      {% with img=art.images.all|first %}
      <article class="card" data-id="{{ art.id }}">
        {% if img %}<img loading="lazy" src="{{ img.image.url }}" alt="{{ art.title }}">{% endif %}
        <div class="card-body">
          <h3>{{ art.title }}</h3>
          <p class="muted">{{ art.display_artist }}</p>
          <div class="card-actions">
            <button class="btn-like" data-id="{{ art.id }}">❤ <span class="likes-count">{{ art.likes_count }}</span></button>
            <button class="btn-bookmark" data-id="{{ art.id }}">{{ art.is_bookmarked|yesno:"Saved,Save" }}</button>
            <a class="btn" href="{% url 'artwork_detail' art.id %}">View</a>
          </div>
        </div>
      </article>
      {% endwith %}
    {% endfor %}
  </div>

  <div id="feed-loading" class="u-center muted" style="padding:18px; display:none;">Loading…</div>
</section>

<script>
(function(){
  let page = 2;
  let loading = false;
  const feed = document.getElementById('pinterest-feed');
  const loader = document.getElementById('feed-loading');

  async function loadPage(){
    if (loading) return;
    loading = true;
    loader.style.display = 'block';
    try {
      const res = await fetch("{% url 'gallery_json' %}?page=" + page);
      const data = await res.json();
      data.items.forEach(item=>{
        const art = document.createElement('article');
        art.className = 'card';
        art.dataset.id = item.id;
        art.innerHTML = `
          ${item.thumb ? `<img loading="lazy" src="${item.thumb}" alt="${item.title}">` : ''}
          <div class="card-body">
            <h3>${item.title}</h3>
            <p class="muted">${item.artist}</p>
            <div class="card-actions">
              <button class="btn-like" data-id="${item.id}">❤ <span class="likes-count">${item.likes_count}</span></button>
              <button class="btn-bookmark" data-id="${item.id}">Save</button>
              <a class="btn" href="/gallery/${item.id}/">View</a>
            </div>
          </div>`;
        feed.appendChild(art);
      });
      if (!data.has_next) {
        loader.innerText = 'No more';
        window.removeEventListener('scroll', onScroll);
      } else {
        page++;
        loader.style.display = 'none';
        loading = false;
      }
    } catch(e){
      console.error(e);
      loader.innerText = 'Error';
    }
  }

  function onScroll(){
    if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 900)) {
      loadPage();
    }
  }
  window.addEventListener('scroll', onScroll);

  document.addEventListener('click', function(e){
    if (e.target.closest('.btn-like')){
      const btn = e.target.closest('.btn-like');
      const id = btn.dataset.id;
      const fd = new FormData(); fd.append('artwork_id', id);
      fetch("{% url 'toggle_like' %}", { method:'POST', headers:{'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1]}, body: fd})
        .then(r=>r.json()).then(res=>{
          if(res.status==='ok') btn.querySelector('.likes-count').innerText = res.likes_count;
        }).catch(()=>{});
    }
    if (e.target.closest('.btn-bookmark')){
      const btn = e.target.closest('.btn-bookmark');
      const id = btn.dataset.id;
      const fd = new FormData(); fd.append('artwork_id', id);
      fetch("{% url 'toggle_bookmark' %}", { method:'POST', headers:{'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1]}, body: fd})
        .then(r=>r.json()).then(res=>{
          if(res.status==='ok') btn.innerText = (res.action==='saved' ? 'Saved' : 'Save');
        }).catch(()=>{});
    }
  });
})();
</script>
{% endblock %}
